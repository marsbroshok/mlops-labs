# Provisioning a lightweight deployment of Kubeflow Pipelines

This lab  describes the steps to provision a lighweight deployment of  Kubeflow Pipelines.

The accompanying lab -  `lab-01-env-setup-ai-notebook` - walks you through the steps required to provision  an AI Platfom Notebooks instance configured based on a custom container image optimized for TFX/KFP development.

You will run provisioning scripts using **Cloud Shell**. 

**Terraform** is pre-installed in **Cloud Shell**. Before running the scripts you need to install **Kustomize**.

To install **Kustomize** in **Cloud Shell**:
```
cd /usr/local//bin
sudo wget https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv3.3.0/kustomize_v3.3.0_linux_amd64.tar.gz
sudo tar xvf kustomize_v3.3.0_linux_amd64.tar.gz
sudo rm kustomize_v3.3.0_linux_amd64.tar.gz
cd
```
The above command installs **Kustomize** to the `/usr/local/bin` folder, which by default is on the `PATH`. **Kustomize** is a single executable. Note that this folder will be reset after you disconnect from **Cloud Shell**. 

The provisioning of a lightweight deployment of Kubeflow Pipelines is performed into two stages:
- Installing the infrastructure services required to host Kubeflow Pipelines
- Deploying Kubeflow Pipelines

## Installing the infrastructure services required to host Kubeflow Pipelines

In this step you provision the infrastructure services required to host Kubeflow Pipelines, including GKE cluster, Cloud SQL and Cloud Storage.

1. Clone this repo under the `home` folder.
```
cd 
git clone https://github.com/jarokaz/mlops-labs.git
cd mlops-labs/environment-setup/lab-02-env-setup-kfp/
```

2. Review the `provision-infra.sh` installation script

3. Run the installation script
```
./provision-infra.sh [PROJECT_ID] [PREFIX] [REGION] [ZONE] 
```
Where 

|Parameter|Optional|Description|
|-------------|---------|-------------------------------|
|[PROJECT_ID]| Required|The project id of your project.|
|[PREFIX]|Optional|A name prefix tha will be added to the names of provisioned resources. If not provided [PROJECT_ID] will be used as the prefix|
|[REGION]|Optional|The region for the Cloud SQL instance.  If not provided the `us-central1` region will be used|
|[ZONE]|Optional|The zone for the GKE cluster.If not provided the `us-central1-a` will be used.|

We recommend using the defaults for the region and the zone.

4. Review the logs generated by the script for any errors.

### Deploying Kubeflow Pipelines 

1. Review the `deploy-kfp.sh` deployment script
2. Run the deployment script

```
./deploy-kfp.sh  [PROJECT_ID] [SQL_PASSWORD] [NAMESPACE] 
```
Where:

|Parameter|Optional|Description|
|-------------|---------|-------------------------------|
|[PROJECT_ID]| Required|The project id of your project.|
|[SQL_PASSWORD]|Required|The password for the Cloud SQL `root` user. In 0.1.36 version of KFP the SQL username must be `root`|
|[NAMESPACE]|Optional|The namespace to deploy KFP to. If not provided the `kubeflow` namespace will be used


## Granting the Cloud Build service account the Project Editor role.
```
PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format="value(projectNumber)")
CLOUD_BUILD_SERVICE_ACCOUNT="${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com"
gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member serviceAccount:$CLOUD_BUILD_SERVICE_ACCOUNT \
  --role roles/editor
```

## Accessing KFP UI

After the installation completes, you can access the KFP UI from the following URL. You may need to wait a few minutes before the URL is operational.

```
echo "https://"$(kubectl describe configmap inverse-proxy-config -n [NAMESPACE] | grep "googleusercontent.com")
```
